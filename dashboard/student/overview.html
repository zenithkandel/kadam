<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Overview</title>
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Roboto:wght@300;400;500&display=swap" rel="stylesheet">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <!-- Styles -->
    <link rel="stylesheet" href="../../assets/css/style.css">
    <link rel="stylesheet" href="../../assets/css/dashboard-content.css">
</head>
<body>
    <!-- Welcome Banner -->
    <div class="welcome-banner">
        <h2>Welcome back, <span id="user-name">Student</span>!</h2>
        <p>Here is your dashboard overview.</p>
        <i class="fa-solid fa-rocket banner-decoration"></i>
    </div>

    <!-- Stats Grid -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-icon green">
                <i class="fa-solid fa-wallet"></i>
            </div>
            <div class="stat-info">
                <h3 id="total-earnings">Rs. 0</h3>
                <p>Total Earnings</p>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon blue">
                <i class="fa-solid fa-list-check"></i>
            </div>
            <div class="stat-info">
                <h3 id="tasks-completed">0</h3>
                <p>Tasks Completed</p>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon orange">
                <i class="fa-solid fa-clock"></i>
            </div>
            <div class="stat-info">
                <h3 id="active-tasks-count">0</h3>
                <p>Active Tasks</p>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon purple">
                <i class="fa-solid fa-star"></i>
            </div>
            <div class="stat-info">
                <h3 id="average-rating">0.0</h3>
                <p>Average Rating</p>
            </div>
        </div>
    </div>

    <!-- Recent Tasks -->
    <div class="section-header">
        <h3>Active Tasks</h3>
        <a href="my-tasks.html" class="view-all">View All</a>
    </div>

    <div class="task-list" id="active-tasks-list">
        <!-- Tasks will be loaded here -->
        <div class="loading-spinner" style="text-align: center; padding: 20px;">
            <i class="fa-solid fa-spinner fa-spin"></i> Loading tasks...
        </div>
    </div>

    <script src="../../assets/js/api.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                // 1. Load User Profile & Stats
                const profileResponse = await ApiHandler.get('auth/me.php');
                if (profileResponse.success) {
                    const user = profileResponse.data;
                    document.getElementById('user-name').textContent = user.name.split(' ')[0];
                    
                    if (user.details) {
                        document.getElementById('total-earnings').textContent = 'Rs. ' + (user.details.total_earned || 0);
                        document.getElementById('tasks-completed').textContent = user.details.tasks_completed_count || 0;
                        document.getElementById('average-rating').textContent = user.details.average_rating || '0.0';
                    }
                }

                // 2. Load Active Tasks
                // Note: We need an endpoint for "My Active Tasks". 
                // For now, we'll use my_tasks.php and filter client-side or assume it returns relevant ones.
                const tasksResponse = await ApiHandler.get('tasks/my_tasks.php');
                const tasksList = document.getElementById('active-tasks-list');
                tasksList.innerHTML = '';

                if (tasksResponse.success && tasksResponse.data.length > 0) {
                    // Filter for active tasks (open, in_progress)
                    const activeTasks = tasksResponse.data.filter(t => ['open', 'in_progress'].includes(t.status));
                    
                    document.getElementById('active-tasks-count').textContent = activeTasks.length;

                    if (activeTasks.length === 0) {
                        tasksList.innerHTML = '<p style="text-align:center; color:var(--text-light);">No active tasks found.</p>';
                    } else {
                        activeTasks.slice(0, 3).forEach(task => {
                            const html = `
                                <div class="task-card">
                                    <div class="task-header">
                                        <span class="task-status status-${task.status}">${task.status.replace('_', ' ')}</span>
                                        <span style="color: var(--text-light); font-size: 0.8rem;">Due: ${task.deadline}</span>
                                    </div>
                                    <h4 class="task-title">${task.title}</h4>
                                    <div class="task-meta">
                                        <span><i class="fa-solid fa-money-bill"></i> Rs. ${task.budget}</span>
                                    </div>
                                </div>
                            `;
                            tasksList.innerHTML += html;
                        });
                    }
                } else {
                    tasksList.innerHTML = '<p style="text-align:center; color:var(--text-light);">No tasks found.</p>';
                }

            } catch (error) {
                console.error('Error loading dashboard:', error);
            }
        });
    </script>
</body>
</html>